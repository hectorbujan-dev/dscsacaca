{% extends "base.html" %}

{% block title %}Estad√≠sticas - Pok√©dex UAX{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">üìä Estad√≠sticas Pok√©mon</h1>
        <p>An√°lisis de datos con agregaciones de MongoDB</p>
    </div>

    <!-- Selectores de Estad√≠sticas -->
    <div class="stats-section">
        <form action="{{ url_for('estadisticas') }}" method="GET" class="stats-filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="stat1">Primera Estad√≠stica:</label>
                    <select name="stat1" id="stat1" class="form-select">
                        <option value="hp" {% if stat1 == 'hp' %}selected{% endif %}>HP</option>
                        <option value="attack" {% if stat1 == 'attack' %}selected{% endif %}>Ataque</option>
                        <option value="defense" {% if stat1 == 'defense' %}selected{% endif %}>Defensa</option>
                        <option value="special_attack" {% if stat1 == 'special_attack' %}selected{% endif %}>Ataque Especial</option>
                        <option value="special_defense" {% if stat1 == 'special_defense' %}selected{% endif %}>Defensa Especial</option>
                        <option value="speed" {% if stat1 == 'speed' %}selected{% endif %}>Velocidad</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="stat2">Segunda Estad√≠stica:</label>
                    <select name="stat2" id="stat2" class="form-select">
                        <option value="hp" {% if stat2 == 'hp' %}selected{% endif %}>HP</option>
                        <option value="attack" {% if stat2 == 'attack' %}selected{% endif %}>Ataque</option>
                        <option value="defense" {% if stat2 == 'defense' %}selected{% endif %}>Defensa</option>
                        <option value="special_attack" {% if stat2 == 'special_attack' %}selected{% endif %}>Ataque Especial</option>
                        <option value="special_defense" {% if stat2 == 'special_defense' %}selected{% endif %}>Defensa Especial</option>
                        <option value="speed" {% if stat2 == 'speed' %}selected{% endif %}>Velocidad</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">üîÑ Actualizar</button>
            </div>
        </form>
    </div>

    <!-- Top 10 Primera Estad√≠stica -->
    <div class="stats-section">
        <h2 class="section-title">üèÜ Top 10 - {{ stat_names[stat1] }}</h2>
        <div class="top-pokemon-grid">
            {% for pokemon in top_stat1 %}
            <div class="top-pokemon-card">
                <div class="rank-badge">#{{ loop.index }}</div>
                <img src="{{ pokemon.img.official_artwork or pokemon.img.front_default }}" 
                     alt="{{ pokemon.name.en }}">
                <h3>{{ pokemon.name.en|capitalize if pokemon.name.en and pokemon.name.en != 'none' else ' ' }}</h3>
                <p class="pokemon-subtitle-small">{{ pokemon.name.es if pokemon.name.es and pokemon.name.es != 'none' else ' ' }}</p>
                <div class="pokemon-types">
                    {% for tipo in pokemon.types %}
                    <span class="type-badge type-{{ tipo }}">{{ tipo }}</span>
                    {% endfor %}
                </div>
                <div class="stat-highlight">
                    <span class="stat-label">{{ stat_names[stat1] }}</span>
                    <span class="stat-number">{{ pokemon.stat_value }}</span>
                </div>
                <a href="{{ url_for('pokemon_detalle', pokemon_id=pokemon.id) }}" class="btn-secondary btn-small">Ver detalles</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Top 10 Segunda Estad√≠stica -->
    <div class="stats-section">
        <h2 class="section-title">‚ö° Top 10 - {{ stat_names[stat2] }}</h2>
        <div class="top-pokemon-grid">
            {% for pokemon in top_stat2 %}
            <div class="top-pokemon-card">
                <div class="rank-badge">#{{ loop.index }}</div>
                <img src="{{ pokemon.img.official_artwork or pokemon.img.front_default }}" 
                     alt="{{ pokemon.name.en }}">
                <h3>{{ pokemon.name.en|capitalize if pokemon.name.en and pokemon.name.en != 'none' else ' ' }}</h3>
                <p class="pokemon-subtitle-small">{{ pokemon.name.es if pokemon.name.es and pokemon.name.es != 'none' else ' ' }}</p>
                <div class="pokemon-types">
                    {% for tipo in pokemon.types %}
                    <span class="type-badge type-{{ tipo }}">{{ tipo }}</span>
                    {% endfor %}
                </div>
                <div class="stat-highlight">
                    <span class="stat-label">{{ stat_names[stat2] }}</span>
                    <span class="stat-number">{{ pokemon.stat_value }}</span>
                </div>
                <a href="{{ url_for('pokemon_detalle', pokemon_id=pokemon.id) }}" class="btn-secondary btn-small">Ver detalles</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Promedios por Generaci√≥n -->
    <div class="stats-section">
        <h2 class="section-title">üìà Promedios de Estad√≠sticas por Generaci√≥n</h2>
        <div class="chart-container">
            <canvas id="generationChart"></canvas>
        </div>
        <div class="generation-table">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Generaci√≥n</th>
                        <th>Total Pok√©mon</th>
                        <th>Prom. HP</th>
                        <th>Prom. Ataque</th>
                        <th>Prom. Defensa</th>
                        <th>Prom. Velocidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gen in promedios_gen %}
                    <tr>
                        <td>{{ gen._id|replace('generation-', 'Gen ')|upper }}</td>
                        <td>{{ gen.total_pokemon }}</td>
                        <td>{{ gen.promedio_hp|round(1) }}</td>
                        <td>{{ gen.promedio_attack|round(1) }}</td>
                        <td>{{ gen.promedio_defense|round(1) }}</td>
                        <td>{{ gen.promedio_speed|round(1) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Distribuci√≥n por Tipos -->
    <div class="stats-section">
        <h2 class="section-title">üé® Distribuci√≥n de Pok√©mon por Tipo</h2>
        <div class="chart-container">
            <canvas id="typesChart"></canvas>
        </div>
    </div>

    <!-- Legendarios y M√≠ticos por Generaci√≥n -->
    <div class="stats-section">
        <h2 class="section-title">‚ú® Pok√©mon Legendarios y M√≠ticos por Generaci√≥n</h2>
        <div class="chart-container">
            <canvas id="legendaryChart"></canvas>
        </div>
    </div>
</div>

<script>
// Gr√°fico de promedios por generaci√≥n
const genCtx = document.getElementById('generationChart').getContext('2d');
new Chart(genCtx, {
    type: 'bar',
    data: {
        labels: [{% for gen in promedios_gen %}'{{ gen._id|replace("generation-", "Gen ")|upper }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [
            {
                label: 'HP',
                data: [{% for gen in promedios_gen %}{{ gen.promedio_hp|round(1) }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#FF5959'
            },
            {
                label: 'Ataque',
                data: [{% for gen in promedios_gen %}{{ gen.promedio_attack|round(1) }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#F5AC78'
            },
            {
                label: 'Defensa',
                data: [{% for gen in promedios_gen %}{{ gen.promedio_defense|round(1) }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#FAE078'
            },
            {
                label: 'Velocidad',
                data: [{% for gen in promedios_gen %}{{ gen.promedio_speed|round(1) }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#9DB7F5'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Gr√°fico de distribuci√≥n por tipos
const typesCtx = document.getElementById('typesChart').getContext('2d');
new Chart(typesCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for tipo in distribucion_tipos %}'{{ tipo._id|capitalize }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for tipo in distribucion_tipos %}{{ tipo.cantidad }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#A8A878', '#EE8130', '#6390F0', '#F7D02C', '#7AC74C',
                '#96D9D6', '#C22E28', '#A33EA1', '#E2BF65', '#A98FF3',
                '#FA6555', '#B6A136', '#B7B7CE', '#735797', '#6F35FC',
                '#705746', '#B09398', '#D685AD'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'right'
            }
        }
    }
});

// Gr√°fico de legendarios y m√≠ticos
const legendaryCtx = document.getElementById('legendaryChart').getContext('2d');
new Chart(legendaryCtx, {
    type: 'bar',
    data: {
        labels: [{% for gen in legendarios_gen %}'{{ gen._id|replace("generation-", "Gen ")|upper }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [
            {
                label: 'Legendarios',
                data: [{% for gen in legendarios_gen %}{{ gen.legendarios }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#FFD700'
            },
            {
                label: 'M√≠ticos',
                data: [{% for gen in legendarios_gen %}{{ gen.miticos }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: '#E6E6FA'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
